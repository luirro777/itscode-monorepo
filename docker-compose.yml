version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: ./dockerfiles/Dockerfile.api
    container_name: ${COMPOSE_PROJECT_NAME}-api
    ports:
      - "${API_PORT}:8080"
    environment:
      - ConnectionStrings__DefaultConnection=Server=mysql;Port=${MYSQL_PORT};Database=${MYSQL_DATABASE};User=${MYSQL_USER};Password=${MYSQL_PASSWORD};
      - ASPNETCORE_ENVIRONMENT=${API_ENVIRONMENT}
    #volumes:
    #  - ./services/api:/app
    depends_on:
      mysql:
        condition: service_healthy

  
  front:
    build:      
      context: .
      dockerfile: ./dockerfiles/Dockerfile.frontend
      args:
        # Pasamos las rutas como argumentos de construcci√≥n
        NGINX_CONFIG_PATH: ./nginx/front/nginx.conf
        APP_SOURCE_PATH: ./services/front
    container_name: ${COMPOSE_PROJECT_NAME}-front
    ports:
      - "${FRONT_PORT}:80"    
    volumes:
      - ./services/front:/usr/share/nginx/html
    depends_on:
      - api

  
  dashboard:
    build:
      context: .
      dockerfile: ./dockerfiles/Dockerfile.dashboard.dev 
    container_name: ${COMPOSE_PROJECT_NAME}-dashboard
    ports:      
      - "${DASHBOARD_PORT}:3000"
    environment:      
      - REACT_APP_API_URL=${API_BASE_URL}
    volumes:      
      - ./services/dashboard/src:/app/src
      - ./services/dashboard/public:/app/public
    depends_on:
      - api

  mysql:
    image: mysql:8.0
    container_name: ${COMPOSE_PROJECT_NAME}-mysql
    ports:
      - "${MYSQL_PORT}:${MYSQL_PORT}"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql      
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  mysql_data:
